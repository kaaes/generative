<!DOCTYPE html>
<html>
  <head></head>
  <style>
  html, 
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  #canvas {
    background: #000;
    width: 100%;
    height: 100%;
  }
  #params {
    position: absolute;
    padding: 20px;
  }
  </style>
  <body>
    <canvas id="canvas"></canvas>
    <script src="animation.js"></script>
    <script src="vector.js"></script>
    <script src="particle.js"></script>
    <script>
    (function() {
      var ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      ctx.globalAlpha = 1;
      //ctx.globalCompositeOperation = 'lighter';
      ctx.lineWidth = 1;
      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'white';

      ctx.translate(-200, 300);
      //ctx.rotate(-60 * Math.PI * 180);

      var parts = [];

      function clearPart(opacity) {
        ctx.save();
        ctx.globalAlpha = opacity;
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(0,0,0,1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();
      }

      var radius = 500;

      for (var i = 0; i < 50; i++) {
        var particle = new Particle();
        particle.radius = Math.ceil(radius);

        radius *= 0.8;

        var pos = parts[i - 1] ? 
          Vector.add(parts[i - 1].position, new Vector(particle.radius / 1.5, 0)) :
          new Vector(50, 150);

        particle.position = pos;
        particle.fillColor = 'rgba(255,255,255,.5)';
        particle.update();

        parts.push(particle);

        if (particle.radius < 10) {
          //particle.radius = 20;
          break;
        }
        
      }

      var angle = 0;
      var angleVel = 0.4;
      var amplitude = 120;

      var startAngle = 0;

      var points = [];

      function draw() {
        angle = startAngle;
        points = [];
        ctx.clearRect(200,-300,canvas.width, canvas.height);
        //ctx.strokeStyle = 'hsla(' + ((Math.sin(counter / 100) * 180)) + ',100%,50%,1)';
        //ctx.rotate(-10 * Math.PI * 180);
        //ctx.beginPath();
        //ctx.moveTo(0, 0);
        for (var i = 0, l = parts.length; i < l; i++) {
          y = parts[i].radius * Math.sin(angle);

          parts[i].position.y = y;
          parts[i].update();

          if (parts[i + 1]) {
            var point = [parts[i].position.x, y + parts[i].radius / 2, y - parts[i].radius / 2];
          } else {
            var point = [parts[i].position.x + parts[i].radius, y, y];
          }

          points.push(point);

          var ang = (y / parts[i].radius) * -15 * Math.PI/180;

          //ctx.save();
          //ctx.translate(parts[i].position.x, y);
          //ctx.rotate(ang);

          // ctx.beginPath();
          // ctx.moveTo(0, -parts[i].radius / 2);
          // ctx.lineTo(0, parts[i].radius/2);
          // ctx.closePath();
          // ctx.stroke();

          // ctx.restore();

          //parts[i].draw(ctx);
 
          angle += angleVel;
        }

        i = 0;
        var dir = 1;

        ctx.beginPath();

        while (points[i]) {

          if (i == points.length - 1) {
            ctx.quadraticCurveTo(points[i - 1][0], points[i - 1][1], points[i][0], points[i][1]);
          }

          if (dir == -1) {
            if (points[i - 1]) {
              var cp = {
                x: (points[i][0] + points[i - 1][0]) / 2,
                y: (points[i][2] + points[i - 1][2]) / 2
              }
              ctx.quadraticCurveTo(points[i][0], points[i][2], cp.x, cp.y);
            }
            //ctx.lineTo(points[i][0], points[i][2]);
          } else {
            if (points[i - 1]) {
              var cp = {
                x: (points[i - 1][0] + points[i][0]) / 2,
                y: (points[i - 1][1] + points[i][1]) / 2
              }
              ctx.quadraticCurveTo(points[i - 1][0], points[i - 1][1], cp.x, cp.y);
            }
            // ctx.lineTo(points[i][0], points[i][1]);
          }

          i += dir;

          if (i == points.length - 1) {
            dir = -1;
          }
        }
        
        ctx.closePath();
        //ctx.stroke();
        ctx.fill();

        startAngle += 0.02;
      }

      var counter = 0;


      var anim = new AnimationFrame(function() {
        draw();  
        counter++;     
      });

      function random(min, max) {
        return min + Math.floor(Math.random() * (max - min + 1));
      }

    })();
    </script>
  </body>
</html>